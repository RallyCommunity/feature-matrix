<!DOCTYPE html>
<html>
<head>
    <title>Feature Summary Matrix</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("FeatureSummaryMatrixApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",appName:"Feature Summary Matrix",scopeType:"release",comboboxConfig:{fieldLabel:"Release ",labelAlign:"right",labelWidth:30,labelPad:15,growToLongestValue:!0,margin:"10px 0",minWidth:230,padding:"0 0 0 5px"},clientMetrics:[{method:"_onMatrixCellClicked",description:"matrix cell clicked"}],initComponent:function(){this.callParent(arguments),this.mon(this,"afterrender",function(){this.setLoading(!0)},this),Rally.data.ModelFactory.getModel({type:"PortfolioItem/Feature",success:this._onFeatureModelRetrieved,scope:this})},_addContent:function(scope){this._hideComponentIfNeeded(this.defectGridHeader),this._hideComponentIfNeeded(this.defectGrid),this.releaseFilter=this.context.getTimeboxScope().getQueryFilter(),this.allFeatureStore?(this.allFeatureStore.clearFilter(!0),this.allFeatureStore.filter(this.releaseFilter)):this._initializeAllFeatureStore()},onScopeChange:function(scope){this.matrixGrid&&this.matrixGrid.setLoading(!0),this._addContent(scope)},onNoAvailableTimeboxes:function(){this.setLoading(!1)},_onFeatureModelRetrieved:function(model){this.defectModel=model,this._extractAllowedValues(model,["State","Priority"]).then({success:function(allowedValues){this.states=allowedValues.State,this.priorities=allowedValues.Priority,this._initializeAllFeatureStore()},scope:this})},_extractAllowedValues:function(defectModel,fieldNames){var result={},that=this;that._statesObjects=[];var deferred=Ext.create("Deft.Deferred");return _.each(fieldNames,function(fieldName){defectModel.getField(fieldName).getAllowedValueStore().load({callback:function(records,operation,success){var allowedValues=_.map(records,function(record){var value=record.get("StringValue"),ref=record.get("_ref");return""===value&&(value="None"),"State"===fieldName&&that._statesObjects.push({name:value,ref:ref}),""===value?"None":value});result[fieldName]=allowedValues,_.keys(result).length===fieldNames.length&&deferred.resolve(result)}})}),deferred.promise},_hideComponentIfNeeded:function(component){component&&component.hide()},_showComponentIfNeeded:function(component){component&&component.isHidden()&&component.show()},_initializeAllFeatureStore:function(){this.releaseFilter&&this.defectModel&&(this.allFeatureStore=Ext.create("Rally.data.wsapi.Store",{model:this.defectModel,fetch:["State","Priority"],autoLoad:!0,limit:1/0,context:this.getContext().getDataContext(),filters:this.releaseFilter,listeners:{load:this._onAllFeatureStoreLoaded,scope:this}}))},_onAllFeatureStoreLoaded:function(store,records,successful,eOpts){this._initializeMatrixTable(),this._populateMatrixTable(records),this._createPriorityRecords(records),this._updateMatrixGrid(),this.setLoading(!1)},_initializeMatrixTable:function(){this.matrixTable=[],Ext.each(this.priorities,function(priority,pIndex){this.matrixTable[pIndex]=[],Ext.each(this.states,function(state,sIndex){this.matrixTable[pIndex][sIndex]=0},this)},this)},_populateMatrixTable:function(defectRecords){var priorityIndex,stateIndex;Ext.each(defectRecords,function(record){var priority=record.get("Priority");priority||(priority="None");var state=record.get("State");state=state?record.get("State")._refObjectName:"None",priorityIndex=this._determinePriorityIndex(priority,record),stateIndex=this._determineStateIndex(state,record),this.matrixTable[priorityIndex][stateIndex]++},this)},_determinePriorityIndex:function(value,record){return this.priorities.indexOf(value)},_determineStateIndex:function(value,record){return this.states.indexOf(value)},_createPriorityRecords:function(defectRecords){var currentRecord,rowTotal,colTotals=Array(this.states);this.priorityRecords=[],Ext.each(this.states,function(state,sIndex){colTotals[sIndex]=0}),Ext.each(this.matrixTable,function(stateArray,priorityIndex){currentRecord={Priority:this.priorities[priorityIndex]},rowTotal=0,Ext.each(stateArray,function(numFeatures,stateIndex){currentRecord[this.states[stateIndex]]=this._createDetailLink(numFeatures),rowTotal+=numFeatures,colTotals[stateIndex]+=numFeatures},this),currentRecord.RowTotal=this._createDetailLink(rowTotal),this.priorityRecords.push(currentRecord)},this),currentRecord={Priority:"Total"},Ext.each(this.states,function(state,sIndex){currentRecord[state]=this._createDetailLink(colTotals[sIndex])},this),currentRecord.RowTotal=this._createDetailLink(defectRecords.length),this.priorityRecords.push(currentRecord)},_updateMatrixGrid:function(){var newMatrixGridStore=this._createMatrixGridStore();this.matrixGrid?(this.matrixGrid.getView().bindStore(newMatrixGridStore),this.matrixGrid.setLoading(!1)):this._createMatrixGrid(newMatrixGridStore)},_createMatrixGridStore:function(){return Ext.create("Rally.data.custom.Store",{data:this.priorityRecords,pageSize:this.priorityRecords.length})},_createMatrixGrid:function(store){this.matrixGrid=this.add(Ext.create("Rally.ui.grid.Grid",{store:store,showPagingToolbar:!1,sortableColumns:!1,showRowActionsColumn:!1,columnCfgs:this._buildColumns(),listeners:{cellclick:this._onMatrixCellClicked,scope:this}}))},_buildColumns:function(){var columns=[{text:"",dataIndex:"Priority",flex:.4}];return Ext.each(this.states,function(state){columns.push({text:state,dataIndex:state,flex:.3})}),columns.push({text:"Total",dataIndex:"RowTotal",flex:.3}),columns},_createDetailLink:function(count){return"<a href='#' onclick='return false;'>"+count+"</a>"},_onMatrixCellClicked:function(table,td,cellIndex,record,tr,rowIndex,e,eOpts){cellIndex--,cellIndex>=0&&this._updateFeatureGrid(rowIndex,cellIndex)},_updateFeatureGrid:function(priorityIndex,stateIndex){var priority=this.priorities[priorityIndex],state=this.states[stateIndex],allPriorities=priority===void 0,allStates=state===void 0,newTitle=this._determineFeatureGridTitle(priority,state,allPriorities,allStates),newFilters=this._createNewFeatureFilters(priority,state,allPriorities,allStates);this.defectGrid?this._changeFeatureGridTitleAndFilters(newTitle,newFilters):this._createFeatureGrid(newTitle,newFilters)},_createFeatureGrid:function(title,filters){this.defectGridHeader=this.add({xtype:"component",itemId:"defectGridHeader",html:title,style:{padding:"20px 0 6px 0",width:"100%",textAlign:"center",fontWeight:"bold"}}),this.defectGrid=this.add({xtype:"rallygrid",itemId:"defectGrid",model:this.defectModel,storeConfig:{filters:filters},autoLoad:!1,columnCfgs:["FormattedID","Name","State","Priority"],limit:1/0,enableEditing:!1,margin:"0 0 10px 0"})},_changeFeatureGridTitleAndFilters:function(newTitle,newFilters){this.defectGridHeader.update(newTitle),this.defectGrid.getStore().clearFilter(!0),this.defectGrid.getStore().filter(newFilters),this._showComponentIfNeeded(this.defectGridHeader),this._showComponentIfNeeded(this.defectGrid)},_createNewFeatureFilters:function(priority,state,allPriorities,allStates){"None"===priority&&(priority="");var newFilters=[this.releaseFilter],currentStateRef="";return _.each(this._statesObjects,function(stateObj){stateObj.name===state&&(currentStateRef=stateObj.ref)}),allPriorities||newFilters.push({property:"Priority",value:priority}),allStates||newFilters.push({property:"State",value:currentStateRef}),newFilters},_determineFeatureGridTitle:function(priority,state,allPriorities,allStates){return allStates||allPriorities?allStates&&allPriorities?"All Features":allPriorities?"All Features With State "+state:allStates?"None"===priority?"All Features Without a Priority":"All "+priority+" Features":"":"None"===priority?"None"===state?"Features Without a Priority and a State":state+" Features Without a Priority":"None"===state?priority+" Features Without a State":"Features With State "+state+" and Priority "+priority}})})();

            Rally.launchApp('FeatureSummaryMatrixApp', {
                name:"Feature Summary Matrix",
	            parentRepos:""
            });

        });
    </script>


</head>
<body></body>
</html>
